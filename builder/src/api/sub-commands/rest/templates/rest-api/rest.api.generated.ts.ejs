import { v4 as uuidv4 } from 'uuid';
import OpenAPIBackend, { UnknownParams, Context, Document } from 'openapi-backend';
import express, { Request as ExpressReq, Response as ExpressRes } from 'express';
import helmet from "helmet";
import { BaseLogger } from '@echo/lib-common';
import { 
    DefaultEventStream, 
    EventStream, 
    CommandContext,
    CommandMetadata, 
    interpretAsApiRestError, 
    DomainLogger,
    JwtToken,
    extractJwtStringFromHeader,
    verifyJwt,
    decodeJwt,
    buildCommandMetadata,
    ApiRestEnvironment,
}  from '@echo/lib-domain-api';

//---------------------------

<% operationImports.forEach(function (operation) { %>
import { 
    <% operation.operationFunctions.forEach(function (operationFunction) { %>
    <%=operationFunction%>, 
    <% }) %>
} from '@root/_generated/<%=operation.operationsFile%>';  
<% }) %>

//---------------------------

<% commandImports.forEach(function (command) { %>
import { <%=command.commandType%> } from '@root/domain/<%=command.aggregateFolder%>/<%=command.commandFolder%>/<%=command.commandFile%>';
<% }) %>

//---------------------------

const baseLogger = new BaseLogger();
const eventStream: EventStream = new DefaultEventStream(baseLogger);

//---------------------------

const api = new OpenAPIBackend({
    definition: `${__dirname}/rest.schema.generated.json`,
    handlers: {

        // TODO
        validationFail: async (c, req: ExpressReq, res: ExpressRes) =>
            res.status(400).json({ err: c.validation.errors }),
        // TODO
        notFound: async (c, req: ExpressReq, res: ExpressRes) => res.status(404).json({ err: 'not found' }),
        // TODO
        notImplemented: async (c, req: ExpressReq, res: ExpressRes) => {
            const { status, mock } = c.api.mockResponseForOperation(
                '' //c.operation.operationId
            );
            return res.status(status).json(mock);
        },

        <% operationHandlers.forEach(function (operation) { %>
        <%=operation.operationId%>: async (
            c: Context<<%= operation.commandType %>, UnknownParams, UnknownParams, UnknownParams, UnknownParams, Document>,
            req: ExpressReq<any, <%= operation.commandType %>, any, any, any>,
            res: ExpressRes
        ) => {           
            let domainLogger: DomainLogger;
            let commandMetadata: CommandMetadata;
            try { 
                let jwt: JwtToken | undefined = undefined;
                const jwtString = extractJwtStringFromHeader(req.headers);
                if(jwtString) {
                    verifyJwt(jwtString);
                    jwt = decodeJwt(jwtString);
                }
                commandMetadata = buildCommandMetadata(uuidv4, jwt, {});
                domainLogger = new DomainLogger(baseLogger, commandMetadata);
            }
            catch(err) {
                baseLogger.error('Framework Error', err as Error /* TODO: make unknown */, { /* TODO: pass in some context */ });
                return res.status(500).json({
                    result: 'error',
                    type: 'Error',
                    messages: ['Error... TBD'], // TODO: 
                });
            }

            try {
                domainLogger.info(`<%=operation.operationId%>, body: ${JSON.stringify(req.body, null, 4)}`);
                const context: CommandContext = { eventStream, generateUuid: uuidv4, logger: domainLogger };
                await <%= operation.operationFunctionName %>(req.body, context, commandMetadata);
                return res.status(200).json({ result: 'ok' });
            } catch (err) {
                return interpretAsApiRestError(res, err, domainLogger);
            }
        },
        <% }) %>
    },
});


//---------------------------
// initalize the backend
api.init();

const app = express();
app.use(helmet());
app.use(express.json());

// use as express middleware
app.use((req: any, res: any) => api.handleRequest(req, req, res));

// start server
app.listen(ApiRestEnvironment.apiRest_port, () => console.info(`api listening at http://localhost:${ApiRestEnvironment.apiRest_port}`));